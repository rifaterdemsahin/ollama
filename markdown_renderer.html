<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Renderer | Ollama Self-Learning</title>
  <link rel="stylesheet" href="nav.css">
  <!-- Prism.js theme -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <style>
    .md-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .md-filename {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 13px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .md-actions { display: flex; gap: 8px; }
    .md-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 12px;
      padding: 5px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: 150ms ease;
    }
    .md-btn:hover { color: var(--text); background: var(--surface2); }
    #md-loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .spinner {
      display: inline-block;
      width: 28px; height: 28px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #md-error {
      display: none;
      background: rgba(248,81,73,.1);
      border: 1px solid rgba(248,81,73,.3);
      border-radius: var(--radius);
      padding: 20px 24px;
      color: var(--red);
      margin: 20px 0;
    }
    #md-content { display: none; }
    .toc-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      margin-bottom: 28px;
      max-width: 320px;
    }
    .toc-title { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: .5px; }
    .toc-list { list-style: none; padding: 0; margin: 0; }
    .toc-list a { font-size: 13px; color: var(--text-muted); text-decoration: none; display: block; padding: 2px 0; }
    .toc-list a:hover { color: var(--accent); }
    .toc-h3 { padding-left: 14px !important; }
    .file-picker {
      max-width: 480px;
      margin: 40px auto;
      text-align: center;
    }
    .file-picker h2 { margin-bottom: 16px; font-size: 18px; color: var(--text-muted); }
    .file-picker input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 14px;
      padding: 10px 14px;
      border-radius: var(--radius);
      outline: none;
      margin-bottom: 12px;
    }
    .file-picker input:focus { border-color: var(--accent); }
    .file-picker button {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 10px 24px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .file-picker button:hover { opacity: .9; }
  </style>
</head>
<body>

<nav id="main-nav" data-root="."></nav>

<main>
  <div id="md-loading">
    <div class="spinner"></div>
    <p id="md-loading-text">Enter a markdown file path above or use ?file=path in the URL</p>
  </div>

  <div id="md-error"></div>

  <div id="md-content">
    <div class="md-toolbar">
      <div class="md-filename">üìù <span id="md-filename-label">‚Äî</span></div>
      <div class="md-actions">
        <a id="md-raw-link" href="#" class="md-btn" target="_blank">üìÑ Raw</a>
        <button onclick="window.print()" class="md-btn">üñ® Print</button>
        <button onclick="copyLink()" class="md-btn" id="copy-btn">üîó Copy Link</button>
      </div>
    </div>

    <div class="breadcrumb" id="md-breadcrumb"></div>

    <div id="md-toc" class="toc-wrap" style="display:none">
      <div class="toc-title">üìë Table of Contents</div>
      <ul class="toc-list" id="toc-items"></ul>
    </div>

    <article class="prose" id="md-body"></article>
  </div>

  <!-- File picker (shown when no file param) -->
  <div class="file-picker" id="file-picker" style="display:none">
    <h2>üìÇ Open a Markdown File</h2>
    <input type="text" id="picker-input" placeholder="e.g. 4_Formula/install.md" value="">
    <br>
    <button onclick="openFile()">Open File</button>

    <div style="margin-top:32px; text-align:left;">
      <div class="section-header">
        <span class="section-emoji">üìö</span>
        <div>
          <div class="section-title">All Markdown Files</div>
          <div class="section-subtitle">Click any file to view it</div>
        </div>
      </div>
      <div id="file-list" class="card-grid" style="margin-top:16px"></div>
    </div>
  </div>
</main>

<footer>
  <p>Markdown Renderer ¬∑ <a href="index.html">‚Üê Back to Home</a></p>
</footer>

<!-- Marked.js for Markdown parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<!-- Prism.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="nav.js"></script>
<script>
(function () {
  'use strict';

  var params = new URLSearchParams(window.location.search);
  var filePath = params.get('file');

  /* configure marked */
  if (typeof marked !== 'undefined') {
    marked.setOptions({ gfm: true, breaks: true });
  }

  if (!filePath) {
    /* show picker */
    document.getElementById('md-loading').style.display = 'none';
    document.getElementById('file-picker').style.display = 'block';
    loadFileList();
    return;
  }

  loadMarkdown(filePath);

  function loadMarkdown(path) {
    document.getElementById('md-loading-text').textContent = 'Loading ' + path + '‚Ä¶';
    document.getElementById('md-loading').style.display = 'block';
    document.getElementById('md-content').style.display = 'none';
    document.getElementById('md-error').style.display = 'none';

    fetch(path)
      .then(function (r) {
        if (!r.ok) throw new Error('HTTP ' + r.status + ' ‚Äî ' + r.statusText);
        return r.text();
      })
      .then(function (text) {
        renderMarkdown(path, text);
      })
      .catch(function (err) {
        document.getElementById('md-loading').style.display = 'none';
        var errEl = document.getElementById('md-error');
        errEl.style.display = 'block';
        errEl.innerHTML = '<strong>‚ö†Ô∏è Could not load file</strong><br>' + path + '<br><br>' +
          '<small>' + err.message + '</small><br><br>' +
          '<a href="index.html" class="md-btn">‚Üê Back to Home</a>';
      });
  }

  function renderMarkdown(path, text) {
    /* set title */
    var parts = path.split('/');
    var fname = parts[parts.length - 1];
    document.title = fname + ' | Ollama Self-Learning';
    document.getElementById('md-filename-label').textContent = path;

    /* raw link */
    var rawLink = document.getElementById('md-raw-link');
    rawLink.href = path;

    /* breadcrumb */
    var bc = document.getElementById('md-breadcrumb');
    var bcHtml = '<a href="index.html">üè† Home</a><span class="breadcrumb-sep">/</span>';
    if (parts.length > 1) {
      var folder = parts.slice(0, -1).join('/');
      bcHtml += '<a href="' + folder + '/index.html">' + folder + '</a><span class="breadcrumb-sep">/</span>';
    }
    bcHtml += '<span>' + fname + '</span>';
    bc.innerHTML = bcHtml;

    /* render */
    var html = (typeof marked !== 'undefined') ? marked.parse(text) : '<pre>' + escHtml(text) + '</pre>';
    var body = document.getElementById('md-body');
    body.innerHTML = html;

    /* build TOC */
    buildTOC(body);

    /* prism highlight */
    if (typeof Prism !== 'undefined') {
      Prism.highlightAllUnder(body);
    }

    /* show */
    document.getElementById('md-loading').style.display = 'none';
    document.getElementById('md-content').style.display = 'block';
  }

  function buildTOC(body) {
    var headings = body.querySelectorAll('h2, h3');
    if (headings.length < 2) return;
    var list = document.getElementById('toc-items');
    list.innerHTML = '';
    headings.forEach(function (h, i) {
      var id = 'heading-' + i;
      h.id = id;
      var li = document.createElement('li');
      var a  = document.createElement('a');
      a.href = '#' + id;
      a.textContent = h.textContent;
      if (h.tagName === 'H3') a.className = 'toc-h3';
      li.appendChild(a);
      list.appendChild(li);
    });
    document.getElementById('md-toc').style.display = 'block';
  }

  function loadFileList() {
    fetch('nav_config.json')
      .then(function (r) { return r.json(); })
      .then(function (cfg) {
        var allFiles = [];
        (cfg.debugMenu || []).forEach(function (x) { allFiles.push({ label: x.label, emoji: x.emoji, path: x.path, desc: x.description }); });
        var container = document.getElementById('file-list');
        container.innerHTML = allFiles.map(function (f) {
          return '<a href="markdown_renderer.html?file=' + f.path + '" class="card section-card" style="text-decoration:none;color:inherit;">' +
            '<span class="card-emoji">' + f.emoji + '</span>' +
            '<div class="card-title">' + f.label + '</div>' +
            '<div class="card-desc text-sm">' + (f.desc || '') + '</div>' +
            '<span class="card-link">View ‚Üí</span>' +
          '</a>';
        }).join('');
      })
      .catch(function () {
        document.getElementById('file-list').innerHTML = '<p class="text-muted">Could not load file list.</p>';
      });
  }

  function openFile() {
    var val = document.getElementById('picker-input').value.trim();
    if (val) window.location.href = 'markdown_renderer.html?file=' + encodeURIComponent(val);
  }

  function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function () {
      var btn = document.getElementById('copy-btn');
      btn.textContent = '‚úÖ Copied!';
      setTimeout(function () { btn.textContent = 'üîó Copy Link'; }, 2000);
    });
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  /* expose for inline handler */
  window.openFile = openFile;
  window.copyLink = copyLink;
})();
</script>
</body>
</html>
